{"version":3,"sources":["serverEngine/ServerControlService.js"],"names":[],"mappings":"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","file":"serverEngine/ServerControlService.js","sourcesContent":["\"use strict\";\r\n\r\n/*\r\n Server control service\r\n \r\n - Provides server control service\r\n - Map routes to sensors control\r\n - Map routes to actuators control\r\n - Map routes to nodes control\r\n - Map routes to nodes net control\r\n \r\n */\r\n\r\nlet EventEmitter = require('events').EventEmitter;\r\nlet portscanner = require('portscanner');\r\nlet express = require('express');\r\n\r\n\r\n\r\n/**\r\n * ServerControlService CONSTANTS\r\n */\r\nconst ServerControlService_CONSTANTS = {\r\n\t\"Events\" : {\r\n\t\t\"ConfigError\": \"Config Error\",\r\n\r\n\t\t\"ServerListening\": \"Server listening\",\r\n\t\t\"ServerClosed\": \"Server closed\"\r\n\r\n\t},\r\n\t\r\n\t\"States\" : {\r\n\t\t\"Config\" : \"Config\",\r\n\t\t\"Running\" : \"Running\",\r\n\t\t\"Error\" : \"Error\"\r\n\t},\r\n\t\r\n\t\"Messages\" : {\r\n\t\t\"getSTNetworkInfo\" : \"Get STNetwork Info\",\r\n\t\t\"STNetworkInfo\" : \"STNetwork Info\"\r\n\r\n\t}\r\n};\r\n\r\n\r\n/**\r\n * SCS_RouteRef\r\n * \r\n * Provides reference to SCS routes\r\n * \r\n */\r\nclass SCS_RouteRef {\r\n\t\r\n\tconstructor(expressRoute, url) {\r\n\t\t\r\n\t\tlet scs_Route = this;\r\n\t\t\r\n\t\tscs_Route.expressRoute = expressRoute;\r\n\t\tscs_Route.url = url;\r\n\t}\r\n\t\r\n\t\r\n}\r\n\r\n\r\n/*\r\n * ServerControlService\r\n * \r\n * Is the service for send and receive data control for Server administration\r\n * \r\n */\r\nclass ServerControlService {\r\n\t\r\n\tconstructor(stServer) {\r\n\t\t\r\n\t\tlet scs = this;\r\n\t\t\r\n\t\tscs.stServer = stServer;\r\n\t\tscs.config = stServer.serverConfiguration.config;\r\n\t\tscs.server = null;\r\n\t\tscs.serverSocket = null;\r\n\t\tscs.eventEmitter = new EventEmitter();\r\n\t\t\r\n\t\tscs.CONSTANTS = ServerControlService_CONSTANTS;\r\n\t\t\r\n\t\tscs.state = ServerControlService_CONSTANTS.States.Config;\r\n\t\t\r\n\t\t\r\n\t\tscs._scsRoutes = null;\r\n\t\t\r\n\t\tscs.routes_Nodes = null;\r\n\t\tscs.routes_Engines = null;\r\n\t\tscs.routes_Sensors = null;\r\n\t\tscs.routes_Actuators = null;\r\n\t\tscs.routes_Net = null;\r\n\t\t\r\n\t}\r\n\t\r\n\t\r\n\tinitialize() {\r\n\t\t\r\n\t\tlet scs = this;\r\n\t\t\r\n\t\tscs._scsRoutes = [];\r\n\t\t\r\n\t\ttry {\r\n\t\t\tscs._init_Nodes();\r\n\t\t} catch (e) {\r\n\t\t\t// TODO: handle exception\r\n\t\t\tthrow \"Cannont initialize Nodes. \" + e;\r\n\t\t}\r\n\t\t\r\n\t\ttry {\r\n\t\t\tscs._init_Engines();\r\n\t\t} catch (e) {\r\n\t\t\t// TODO: handle exception\r\n\t\t\tthrow \"Cannont initialize Engines. \" + e;\r\n\t\t}\r\n\t\t\r\n\t\ttry {\r\n\t\t\tscs._init_Net();\r\n\t\t} catch (e) {\r\n\t\t\t// TODO: handle exception\r\n\t\t\tthrow \"Cannont initialize Net. \" + e;\r\n\t\t}\r\n\t\t\r\n//\t\tscs._init_Engines__OLD();\r\n\t\t\r\n\t\t\r\n\t\t\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * Initialize control routes \r\n\t * for nodes\r\n\t */\r\n\t_init_Nodes() {\r\n\t\t\r\n\t\tlet scs = this;\r\n\t\t\r\n\t\tlet SCS_RouteNodes = require('./scs_routes/SCS_RouteNodes.js');\r\n\t\t\r\n\t\tconsole.log('<~*~> ServerControlService._init_Nodes');\t// TODO REMOVE DEBUG LOG\r\n\r\n\t\tscs.routes_Nodes = new SCS_RouteNodes( scs.stServer.nodesManager );\r\n\t\tlet scsRoutes_Nodes = new SCS_RouteRef(scs.routes_Nodes.expressRoute, \"/Nodes\");\r\n\t\tscs._scsRoutes.push(scsRoutes_Nodes);\r\n\t\t\r\n\t}\r\n\t\r\n\t\r\n\t\r\n\t/**\r\n\t * Initialize control routes \r\n\t * for Engines\r\n\t */\r\n\t_init_Engines() {\r\n\t\t\r\n\t\tlet scs = this;\r\n\t\tlet stServer = scs.stServer;\r\n\t\tlet ngSYS = stServer.ngSYS;\r\n\t\t\r\n\t\tconsole.log('<~*~> ServerControlService._init_Engines');\t// TODO REMOVE DEBUG LOG\r\n\t\t\r\n\t\t\r\n\t\ttry {\r\n\t\t\t\r\n\t\t\tscs.routes_Engines = ngSYS.getSCSRoutes(\r\n\t\t\t\t{\r\n\t\t\t\t\t\"ngSYS\" : ngSYS\r\n\t\t\t\t\t\r\n\t\t\t\t});\r\n\t\t\t\r\n\t\t} catch (e) {\r\n\t\t\t// TODO: handle exception\r\n\t\t\tthrow \"Cannot get SCS Routes. \" + e;\r\n\t\t}\r\n\r\n\t\t\r\n\t\tlet scsRoutes_Engines = new SCS_RouteRef(scs.routes_Engines.expressRoute, \"/ngn\");\r\n\t\tscs._scsRoutes.push(scsRoutes_Engines);\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * Initialize control routes \r\n\t * for Net\r\n\t */\r\n\t_init_Net() {\r\n\t\t\r\n\t\tlet scs = this;\r\n\t\t\r\n\t\tconsole.log('<~*~> ServerControlService._init_Net');\t// TODO REMOVE DEBUG LOG\r\n\r\n\t\t\r\n\t\tlet SCS_RouteNet = require('st.network').get_SCS_RouteNet();\r\n\t\t\r\n\t\tscs.routes_Net = new SCS_RouteNet(\r\n\t\t\t\tscs.stServer.nodesManager, \r\n\t\t\t\tscs.stServer.nodesNetManager, \r\n\t\t\t\tscs.stServer.serverNetManager);\r\n\t\t\r\n\t\tlet scsRoutes_Net = new SCS_RouteRef(scs.routes_Net.expressRoute, \"/Net\");\r\n\t\tscs._scsRoutes.push(scsRoutes_Net);\r\n\t\t\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * Start service\r\n\t * \r\n\t * @throws Exceptions\r\n\t */\r\n\tstartService() {\r\n\t\t\r\n\t\tlet scs = this;\r\n\t\t\r\n\t\tif (scs.server !== null) {\r\n\t\t\t throw \"Server is running\";\r\n\t\t}\r\n\t\t\r\n\t\tscs.server = express();\r\n//\t\tscs.server.use(express.bodyParser());\t// Middleware for use JSON on HTTP posts.\r\n\t\tscs.mapServiceRoutes();\r\n\r\n\t\t\r\n\t\tconsole.log('<~*~> ST Server.ServerControlService.startService');\t// TODO REMOVE DEBUG LOG\r\n\r\n\t\t\r\n\t\t/*\r\n\t\t \r\n\t\tDataChannel.portInUse( scs.config.server.controlPort, function(_portInUse) {\r\n\t\t\tif (_portInUse) {\r\n\t\t\t\tscs.eventEmitter.emit( scs.CONSTANTS.Events.ConfigError );\r\n\t\t\t} else {\r\n\t\t\t\tscs.serverSocket = scs.server.listen( scs.config.server.controlPort );\r\n\t\t\t\tscs.eventEmitter.emit( scs.CONSTANTS.Events.ServerListening );\r\n\t\t\t}\r\n\t\t});\r\n\t\t\r\n\t\t*/\r\n\t\t\r\n\t\t\r\n\t\t// Checks the status of a single port\r\n\t\tportscanner.checkPortStatus(scs.config.server.controlPort, scs.config.server.netLocation, function(error, status) {\r\n\t\t  // Status is 'open' if currently in use or 'closed' if available\r\n\t\t  \r\n\t\t  switch (status) {\r\n\t\t  \r\n\t\t\tcase 'closed':\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tscs.serverSocket = scs.server.listen( scs.config.server.controlPort, scs.config.server.netLocation );\r\n//\t\t\t\tscs.serverSocket = scs.server.listen( scs.config.server.controlPort );\r\n\t\t\t\t\r\n\t\t\t\tscs.state = scs.CONSTANTS.States.Running;\r\n\t\t\t\tscs.eventEmitter.emit( scs.CONSTANTS.Events.ServerListening );\r\n\t\t\t\tbreak;\r\n\t\r\n\t\t\tdefault:\r\n\t\t\t\tscs.state = scs.CONSTANTS.States.Error;\r\n\t\t\t\tscs.eventEmitter.emit( scs.CONSTANTS.Events.ConfigError );\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t\t\r\n\t\t\r\n\t\t/*\r\n\t\t \r\n\t\ttry {\r\n\t\t\tscs.serverSocket = scs.server.listen( scs.config.server.controlPort );\r\n\t\t\tscs.eventEmitter.emit( scs.CONSTANTS.Events.ServerListening );\r\n\t\t} catch (e) {\r\n\t\t\t// TODO: handle exception\r\n\t\t\tscs.eventEmitter.emit( scs.CONSTANTS.Events.ConfigError );\r\n\r\n\t\t}\r\n\r\n\t\t*/\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * Map Service routes\r\n\t */\r\n\tmapServiceRoutes() {\r\n\t\t\r\n\t\tlet scs = this;\r\n\t\t\r\n\t\tscs.server.get('/', function(req, res){\r\n\t\t\t  res.send('ST Server Control Service');\r\n\t\t\t});\r\n\t\t\r\n\t\tscs._scsRoutes.forEach(function(_route, _i) {\n\t\t\tscs.server.use(_route.url, _route.expressRoute);\n\t\t});\r\n\t\t\r\n\t\t\r\n\t\t/*\r\n\t\t \r\n\t\tscs.routes_Sensors = new SCS_RouteSensors( scs.stServer.sensorsManager );\r\n\t\tscs.server.use('/Sensors', scs.routes_Sensors.expressRoute);\r\n\t\t\r\n\t\tscs.routes_Actuators = new SCS_RouteActuators( scs.stServer.actuatorsManager );\r\n\t\tscs.server.use('/Actuators', scs.routes_Actuators.expressRoute);\r\n\r\n\t\tscs.routes_Nodes = new SCS_RouteNodes( scs.stServer.nodesManager );\r\n\t\tscs.server.use('/Nodes', scs.routes_Nodes.expressRoute);\r\n\r\n\t\tscs.routes_Net = new SCS_RouteNet(scs.stServer.nodesManager, scs.stServer.nodesNetManager, scs.stServer.serverNetManager);\r\n\t\tscs.server.use('/Net', scs.routes_Net.expressRoute);\r\n\t\t\r\n\t\t*/\r\n\t\t\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * Stop service\r\n\t * \r\n\t * @throws Exceptions\r\n\t */\r\n\tstopService() {\r\n\t\t\r\n\t\tlet scs = this;\r\n\t\r\n\t\tif (scs.server === null) {\r\n\t\t\t throw \"Server not running\";\r\n\t\t}\r\n\t\t\r\n\t\tconsole.log('<~*~> ST Server.ServerControlService.stopService');\t// TODO REMOVE DEBUG LOG\r\n\r\n\t\t\r\n\t\tif (scs.state === scs.CONSTANTS.States.Running) {\r\n\t\t\tscs.serverSocket.close();\r\n\t\t}\r\n\t\t\r\n\t\tscs.eventEmitter.emit( scs.CONSTANTS.Events.ServerClosed );\r\n\t\tscs.server = null;\r\n\t\tscs.serverSocket = null;\r\n\t}\r\n\t\r\n}\r\n\r\nmodule.exports = ServerControlService;"],"sourceRoot":"C:\\Users\\Felipe\\Documents\\Work\\SomeThings\\dev\\NLVL_STServer\\es6"}