{"version":3,"sources":["serverEngine/NodesControlService.js"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;;AAWA,IAAI,eAAe,QAAQ,QAAR,EAAkB,YAArC;AACA,IAAI,cAAc,QAAQ,aAAR,CAAlB;AACA,IAAI,OAAO,QAAQ,MAAR,CAAX;;AAEA,IAAI,cAAc,QAAQ,YAAR,EAAsB,WAAxC;;;;;AAMA,IAAM,gCAAgC;;AAErC,WAAW;AACV,iBAAe,cADL;;AAGV,qBAAmB,kBAHT;AAIV,kBAAgB,eAJN;AAKV,mBAAiB,gBALP;AAMV,sBAAoB;;AANV,EAF0B;;AAYrC,WAAW;AACV,YAAW,QADD;AAEV,aAAY,SAFF;AAGV,WAAU;AAHA,EAZ0B;;AAkBrC,aAAa;AACZ,sBAAqB,oBADT;AAEZ,mBAAkB;;AAFN;AAlBwB,CAAtC;;;;;;;;;IAgCM,mB;AAEL,8BAAY,MAAZ,EAAoB;AAAA;;AAEnB,OAAK,MAAL,GAAc,MAAd;AACA,OAAK,MAAL,GAAc,IAAd;AACA,OAAK,YAAL,GAAoB,IAApB;AACA,OAAK,YAAL,GAAoB,IAAI,YAAJ,EAApB;;AAEA,OAAK,SAAL,GAAiB,6BAAjB;;AAEA,OAAK,KAAL,GAAa,8BAA8B,MAA9B,CAAqC,MAAlD;AACA;;;;;;;;;;;iCAQc;;AAEd,OAAI,MAAM,IAAV;;AAEA,OAAI,IAAI,MAAJ,KAAe,IAAnB,EAAyB;AACvB,UAAM,mBAAN;AACD;;AAED,OAAI,MAAJ,GAAa,QAAQ,WAAR,GAAb;;;AAGA,OAAI,MAAJ,CAAW,EAAX,CAAc,YAAd,EAA4B,UAAS,MAAT,EAAgB;;;AAG3C,QAAI,YAAJ,CAAiB,IAAjB,CAAuB,IAAI,SAAJ,CAAc,MAAd,CAAqB,aAA5C,EAA4D,EAAC,UAAW,MAAZ,EAA5D;;AAEA,WAAO,EAAP,CAAU,YAAV,EAAwB,YAAU;;;AAGjC,SAAI,YAAJ,CAAiB,IAAjB,CAAuB,IAAI,SAAJ,CAAc,MAAd,CAAqB,gBAA5C,EAA+D,EAAC,UAAW,MAAZ,EAA/D;AAEA,KALD;;AAOA,QAAI,kBAAJ,CAAuB,MAAvB;AAEA,IAdD;;;AAkBA,eAAY,eAAZ,CAA4B,IAAI,MAAJ,CAAW,KAAX,CAAiB,WAA7C,EAA0D,WAA1D,EAAuE,UAAS,KAAT,EAAgB,MAAhB,EAAwB;;;;AAI7F,YAAQ,MAAR;AACD,UAAK,QAAL;;AAEC,UAAI,IAAI,MAAJ,CAAW,KAAX,CAAiB,WAAjB,KAAiC,SAArC,EAAgD;AAC/C,WAAI,MAAJ,CAAW,MAAX,CAAmB,IAAI,MAAJ,CAAW,KAAX,CAAiB,WAApC;AACA,OAFD,MAEO;;;AAGN,WAAI,OAAJ,GAAc,KAAK,YAAL,EAAd;AACA,WAAI,OAAJ,CAAY,MAAZ,CACE,IAAI,MAAJ,CAAW,KAAX,CAAiB,WADnB,EAEE,IAAI,MAAJ,CAAW,KAAX,CAAiB,WAFnB;;AAIA,WAAI,MAAJ,CAAW,MAAX,CAAmB,IAAI,OAAvB;AACA;;AAED,UAAI,KAAJ,GAAY,IAAI,SAAJ,CAAc,MAAd,CAAqB,OAAjC;AACA,UAAI,YAAJ,CAAiB,IAAjB,CAAuB,IAAI,SAAJ,CAAc,MAAd,CAAqB,eAA5C,E;AACA;;AAED;AACC,UAAI,KAAJ,GAAY,IAAI,SAAJ,CAAc,MAAd,CAAqB,KAAjC;AACA,UAAI,YAAJ,CAAiB,IAAjB,CAAuB,IAAI,SAAJ,CAAc,MAAd,CAAqB,WAA5C,E;AACA;AAvBA;AAyBD,IA7BD;AA+BA;;;;;;;;qCAMkB,M,EAAO;AACzB,OAAI,MAAM,IAAV;;;AAGE,UAAO,EAAP,CAAW,IAAI,SAAJ,CAAc,QAAd,CAAuB,gBAAlC,EAAoD,UAAS,GAAT,EAAa;;AAEhE,QAAI,UAAU;AACf,mBAAe,UADA;AAEf,gBAAY,QAAQ,GAAR,CAAY,mBAFT;AAGf,oBAAgB,IAAI,MAAJ,CAAW,KAAX,CAAiB;AAHlB,KAAd;;AAMA,WAAO,IAAP,CAAY,IAAI,SAAJ,CAAc,QAAd,CAAuB,aAAnC,EAAkD,OAAlD,E;AAEA,IAVD;AAWF;;;;;;;;;;gCAQa;;AAEb,OAAI,MAAM,IAAV;;AAEA,OAAI,IAAI,MAAJ,KAAe,IAAnB,EAAyB;AACvB,UAAM,oBAAN;AACD;;AAGD,OAAI,IAAI,KAAJ,KAAc,IAAI,SAAJ,CAAc,MAAd,CAAqB,OAAvC,EAAgD;AAC/C,QAAI,MAAJ,CAAW,KAAX;AACA;;AAED,OAAI,YAAJ,CAAiB,IAAjB,CAAuB,IAAI,SAAJ,CAAc,MAAd,CAAqB,YAA5C,E;AACA,OAAI,MAAJ,GAAa,IAAb;AACA;;;;;;AAKF,OAAO,OAAP,GAAiB,mBAAjB","file":"serverEngine/NodesControlService.js","sourcesContent":["\"use strict\";\n\n/*\n Nodes Control service\n\n - Provides Nodes control service\n - Start/Stop service\n - Manage message [getSTNetworkInfo]->[STNetworkInfo]\n\n */\n\nlet EventEmitter = require('events').EventEmitter;\nlet portscanner = require('portscanner');\nlet http = require('http');\n\nlet DataChannel = require('st.network').DataChannel;\n\n\n/**\n * NodesControlService CONSTANTS\n */\nconst NodesControlService_CONSTANTS = {\n\n\t\"Events\" : {\n\t\t\"ConfigError\": \"Config Error\",\n\n\t\t\"ServerListening\": \"Server listening\",\n\t\t\"ServerClosed\": \"Server closed\",\n\t\t\"NodeConnected\": \"Node Connected\",\n\t\t\"NodeDisconnected\": \"Node Disconnected\"\n\n\t},\n\n\t\"States\" : {\n\t\t\"Config\" : \"Config\",\n\t\t\"Running\" : \"Running\",\n\t\t\"Error\" : \"Error\"\n\t},\n\n\t\"Messages\" : {\n\t\t\"getSTNetworkInfo\" : \"Get STNetwork Info\",\n\t\t\"STNetworkInfo\" : \"STNetwork Info\"\n\n\t}\n};\n\n\n/*\n * NodesControlService\n *\n * Is the service for send and receive control messages with Nodes\n *\n */\nclass NodesControlService {\n\n\tconstructor(config) {\n\n\t\tthis.config = config;\n\t\tthis.server = null;\n\t\tthis.serverSocket = null;\n\t\tthis.eventEmitter = new EventEmitter();\n\n\t\tthis.CONSTANTS = NodesControlService_CONSTANTS;\n\n\t\tthis.state = NodesControlService_CONSTANTS.States.Config;\n\t}\n\n\n\t/**\n\t * Start service\n\t *\n\t * @throws Exceptions\n\t */\n\tstartService() {\n\n\t\tlet ncs = this;\n\n\t\tif (ncs.server !== null) {\n\t\t\t throw \"Server is running\";\n\t\t}\n\n\t\tncs.server = require('socket.io')();\n\n\t\t// Map event connection... provides a new socket\n\t\tncs.server.on('connection', function(socket){\n\n\t\t\t// Emit event NodeConnected\n\t\t\tncs.eventEmitter.emit( ncs.CONSTANTS.Events.NodeConnected , {\"socket\" : socket} );\n\n\t\t\tsocket.on('disconnect', function(){\n\t\t\t\t\n\t\t\t\t// Emit event NodeDisconnected\n\t\t\t\tncs.eventEmitter.emit( ncs.CONSTANTS.Events.NodeDisconnected , {\"socket\" : socket} );\n\n\t\t\t});\n\n\t\t\tncs.mapControlMessages(socket);\n\n\t\t});\n\n\n\t\t// Checks the status of a single port\n\t\tportscanner.checkPortStatus(ncs.config.nodes.controlPort, '127.0.0.1', function(error, status) {\n\t\t  // Status is 'open' if currently in use or 'closed' if available\n\t\t  // console.log(status)\n\n\t\t  switch (status) {\n\t\t\tcase 'closed':\n\t\t\t\t\n\t\t\t\tif (ncs.config.nodes.netLocation === \"0.0.0.0\") {\n\t\t\t\t\tncs.server.listen( ncs.config.nodes.controlPort );\n\t\t\t\t} else {\n\t\t\t\t\t\n\t\t\t\t\t// Connect socket.IO to any IP...\n\t\t\t\t\tncs._server = http.createServer();\n\t\t\t\t\tncs._server.listen(\n\t\t\t\t\t\t\tncs.config.nodes.controlPort, \n\t\t\t\t\t\t\tncs.config.nodes.netLocation);\n\t\t\t\t\t\n\t\t\t\t\tncs.server.listen( ncs._server );\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tncs.state = ncs.CONSTANTS.States.Running;\n\t\t\t\tncs.eventEmitter.emit( ncs.CONSTANTS.Events.ServerListening ); // Emit event ServerListening\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tncs.state = ncs.CONSTANTS.States.Error;\n\t\t\t\tncs.eventEmitter.emit( ncs.CONSTANTS.Events.ConfigError ); // Emit event ConfigError\n\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\n\t}\n\n\n\t/**\n\t * Map control messages\n\t */\n\tmapControlMessages(socket){\n\t\tlet ncs = this;\n\n\t\t  // Map Message getSTNetworkInfo\n\t\t  socket.on( ncs.CONSTANTS.Messages.getSTNetworkInfo, function(msg){\n\n\t\t\t  let dataMSG = {\n\t\t\t\t\"serverType\" : \"STServer\",\n\t\t\t\t\"version\" : process.env.npm_package_version,\n\t\t\t\t\"controlPort\" : ncs.config.nodes.controlPort\n\t\t\t  };\n\n\t\t\t  socket.emit(ncs.CONSTANTS.Messages.STNetworkInfo, dataMSG);\t// Send Message STNetworkInfo\n\n\t\t  });\n\t}\n\n\n\t/**\n\t * Stop service\n\t *\n\t * @throws Exceptions\n\t */\n\tstopService() {\n\n\t\tlet ncs = this;\n\n\t\tif (ncs.server === null) {\n\t\t\t throw \"Server not running\";\n\t\t}\n\n\n\t\tif (ncs.state === ncs.CONSTANTS.States.Running) {\n\t\t\tncs.server.close();\n\t\t}\n\n\t\tncs.eventEmitter.emit( ncs.CONSTANTS.Events.ServerClosed );\t// Emit event ServerClosed\n\t\tncs.server = null;\n\t}\n\t\n}\n\n\nmodule.exports = NodesControlService;\n"],"sourceRoot":"C:\\Users\\Felipe\\Documents\\Work\\SomeThings\\dev\\NLVL_STServer\\es6"}