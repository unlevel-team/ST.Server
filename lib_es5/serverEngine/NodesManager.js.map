{"version":3,"sources":["serverEngine/NodesManager.js"],"names":[],"mappings":"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","file":"serverEngine/NodesManager.js","sourcesContent":["\"use strict\";\r\n\r\n/*\r\n Nodes Manager\r\n \r\n - Provides nodes management\r\n - Manage event [NodeAdded]\r\n - Manage message [getNodeInfo]->[NodeInfo] and set configuration of node\r\n - Manage event [NodeDisconnected]\r\n - Shutdown node\r\n \r\n */\r\n\r\n/**\r\n * import EventEmitter\r\n * @ignore\r\n */\r\nlet EventEmitter = require('events').EventEmitter;\r\n\r\n\r\n/**\r\n * NodesManager_CONSTANTS\r\n * @memberof st.serverEngine\r\n */\r\nconst NodesManager_CONSTANTS = {\r\n\t\t\r\n\t\t\"States\" : {\r\n\t\t\t\"Setup\" : \"Setup\",\r\n\t\t\t\"Ready\" : \"Ready\"\r\n\t\t\t\r\n\t\t},\r\n\t\t\r\n\t\t\"Events\" : {\r\n\t\t\t\"NodeDisconnected\": \"Node Disconnected\",\r\n\t\t\t\"NodeRemoved\": \"Node Removed\",\r\n\t\t\t\"NodeAdded\": \"Node Added\"\r\n\r\n\r\n\t\t},\r\n\t\t\r\n\t\t\"Messages\" : {\r\n\t\t\t\"getNodeInfo\" : \"Get Node Info\",\r\n\t\t\t\"NodeInfo\" : \"Node Info\",\r\n\t\t\t\"BadNodeConfig\" : \"Bad Node Config\",\r\n\t\t\t\r\n\t\t\t\"ShutDownNode\" : \"ShutDownNode\"\r\n\r\n\t\t}\r\n};\r\n\r\n\r\n/**\r\n * ST Node\r\n * \r\n * @class\r\n * @memberof st.serverEngine\r\n * \r\n * @property {string} state - State\r\n * @property {object} config - Configuration object\r\n * @property {object} socket - Socket object\r\n * @property {object} eventEmitter - Object for emit events\r\n * \r\n * \r\n */\r\nclass Node {\r\n\t\r\n\t/**\r\n\t * @constructs Node\r\n\t * \r\n\t * @param {object} config - Configuration object\r\n\t * @param {object} socket - Socket object\r\n\t */\r\n\tconstructor(config, socket) {\r\n\t\t\r\n\t\tthis.state = null;\r\n\t\t\r\n\t\tthis.config = config;\r\n\t\tthis.socket = socket;\r\n\t\t\r\n\t\tthis.eventEmitter = new EventEmitter();\r\n\r\n\t\tthis.CONSTANTS = NodesManager_CONSTANTS;\r\n\t\t\r\n\t\tthis.mapSocketEvents();\r\n\t\tthis.mapSocketMessages();\r\n\r\n\t\tif (this.config === undefined ||\r\n\t\t\t\tthis.config === null) {\r\n\t\t\tthis.state = this.CONSTANTS.States.Setup;\r\n\t\t\t// Emit message getNodeInfo\r\n\t\t\tthis.socket.emit( this.CONSTANTS.Messages.getNodeInfo );\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t}\r\n\t\r\n\t/**\r\n\t * Map socket events\r\n\t */\r\n\tmapSocketEvents() {\r\n\t\t\r\n\t\tlet node = this;\r\n\t\t\r\n\t\t// Map event disconnect\r\n\t\tnode.socket.on('disconnect', function(){\r\n\t\t\t// Emit event NodeDisconnected\r\n\t\t\tnode.eventEmitter.emit( node.CONSTANTS.Events.NodeDisconnected , {\"node\" : node} );\t\r\n\t\t  });\r\n\t\t\r\n\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * Map socket messages\r\n\t */\r\n\tmapSocketMessages() {\r\n\t\t\r\n\t\tlet node = this;\r\n\t\t\r\n\t\t// Map message NodeInfo\r\n\t\tnode.socket.on(node.CONSTANTS.Messages.NodeInfo, function(msg){\r\n\t\t\t\r\n\t\t\tconsole.log('<*> ST Node.Messages.NodeInfo');\t// TODO REMOVE DEBUG LOG\r\n\t\t\tconsole.log(msg);\t// TODO REMOVE DEBUG LOG\r\n\t\t\t\r\n\t\t\tnode.config = msg;\r\n\t\t\t  \r\n\t\t\t// Emit event NodeAdded\r\n\t\t\tnode.eventEmitter.emit( node.CONSTANTS.Events.NodeAdded , {\"node\" : node} );\r\n\r\n\t\t});\r\n\t\t\r\n\t}\r\n\t\r\n}\r\n\r\n\r\n\r\n/**\r\n * The ServerConfiguration JSON file.\r\n * \r\n * @typedef {Object} Result_Node\r\n * @memberof st.serverEngine.NodesManager\r\n * @type Object\r\n * \r\n * @property {st.serverEngine.Node} stNode - Node\r\n * @property {number} position - Node position in list\r\n * \r\n * \r\n */\r\n\r\n\r\n\r\n/**\r\n * ST Nodes Manager\r\n * \r\n * @class\r\n * @memberof st.serverEngine\r\n * \r\n * @property {Node[]} nodeList - Nodes list\r\n * @property {object} eventEmitter - Object for emit events\r\n * \r\n */\r\nclass NodesManager {\r\n\t\r\n\t/**\r\n\t * \r\n\t * @constructs NodesManager\r\n\t */\r\n\tconstructor() {\r\n\t\tthis.nodeList = [];\r\n\t\t\r\n\t\tthis.eventEmitter = new EventEmitter();\r\n\r\n\t\t\r\n\t\tthis.CONSTANTS = NodesManager_CONSTANTS;\r\n\r\n\t}\r\n\t\r\n\t/**\r\n\t * Add ST Node\r\n\t * \r\n\t * @param {object} config - Node configuration\r\n\t * @param {socket} socket - Node control socket\r\n\t */\r\n\taddNode(config, socket) {\r\n\t\t\r\n\t\tlet stNode = new Node(config, socket);\r\n\t\tlet ndm = this;\r\n\t\t\r\n\t\t// Map Event NodeAdded\r\n\t\tstNode.eventEmitter.on( stNode.CONSTANTS.Events.NodeAdded, function(data){\r\n\t\t\t\r\n\t\t\tndm._event_NodeAdded(data, stNode);\r\n\t\t});\r\n\t\t\r\n\t\t\r\n\t\t// Map Event NodeDisconnected\t\t\r\n\t\tstNode.eventEmitter.on( stNode.CONSTANTS.Events.NodeDisconnected, function(data){\r\n\t\t\r\n\t\t\tndm._event_NodeDisconnected(data, stNode);\r\n\t\t});\r\n\r\n\t\t\r\n\t\tndm.nodeList.push(stNode);\r\n\t\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * Returns Node searched by ID\r\n\t * \r\n\t * @param {string} nodeID - Node ID\r\n\t * @param {string} state - State\r\n\t * \r\n\t * @returns {NodesManager.Result_Node} \r\n\t */\r\n\tgetNodeByID(nodeID, state) {\r\n\t\t\r\n\t\tlet ndm = this;\r\n\t\tlet nodesList = ndm.nodeList;\r\n\t\t\r\n\t\tlet node = null;\r\n\t\tlet _i = -1;\r\n\t\t\r\n\t\tif (state === undefined) {\r\n\t\t\tstate = NodesManager_CONSTANTS.States.Ready;\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\t_i = nodesList.map(function(x) {return x.config.nodeID; }).indexOf(nodeID);\r\n\t\tif (_i !== -1) {\r\n\t\t\tnode = nodesList[_i];\r\n\t\t}\r\n\t\t\r\n//\t\tfor (_i = 0; _i < nodesList.length; _i++) {\r\n//\t\t\tif (nodesList[_i].config.nodeID == nodeID && \r\n//\t\t\t\t\tnodesList[_i].state == state) {\r\n//\t\t\t\tnode = nodesList[_i];\r\n//\t\t\t\tbreak;\r\n//\t\t\t}\r\n//\t\t}\r\n\t\t\r\n\t\treturn {\r\n\t\t\t\"stNode\": node,\r\n\t\t\t\"position\": _i\r\n\t\t};\r\n\t\t\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * Returns Node searched by Socket\r\n\t * \r\n\t * @param {object} socket - Socket object\r\n\t * \r\n\t * @returns {NodesManager.Result_Node} \r\n\t */\r\n\tgetNodeBySocket(socket) {\r\n\r\n\t\tlet ndm = this;\r\n\t\tlet nodesList = ndm.nodeList;\r\n\t\t\r\n\t\tlet node = null;\r\n\t\tlet _i = 0;\r\n\t\t\r\n\t\t_i = nodesList.map(function(x) {return x.socket.id; }).indexOf(socket.id);\r\n\t\tif (_i !== -1) {\r\n\t\t\tnode = nodesList[_i];\r\n\t\t}\r\n\t\t\r\n\t\treturn {\r\n\t\t\t\"stNode\": node,\r\n\t\t\t\"position\": _i\r\n\t\t};\r\n\t\t\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * ShutDown Node\r\n\t * \r\n\t * @param {string} nodeID - Node ID\r\n\t */\r\n\tshutDownNode(nodeID) {\r\n\t\tlet ndm = this;\r\n\t\t\r\n\t\tlet nodeSearch = ndm.getNodeByID(nodeID);\r\n\t\tif (nodeSearch.stNode !== null ){\r\n\t\t\tnodeSearch.stNode.socket.emit( ndm.CONSTANTS.Messages.ShutDownNode );\t// Emit message ShutDownNode\r\n\t\t}\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * Event NodeAdded\r\n\t */\r\n\t_event_NodeAdded(data, stNode) {\r\n\t\t\r\n\t\tlet ndm = this;\r\n\t\t\r\n\t\tlet nodeSearch = ndm.getNodeByID( data.node.config.nodeID );\r\n\t\tif (nodeSearch.stNode !== null &&\r\n\t\t\t\tnodeSearch.stNode.state === ndm.CONSTANTS.States.Ready) {\r\n\t\t\t\r\n\t\t\t// Emit message BadNodeConfig\r\n\t\t\tstNode.socket.emit(ndm.CONSTANTS.Messages.BadNodeConfig, {\r\n\t\t\t\t\"message\" : \"nodeID duplicated.\"\r\n\t\t\t});\r\n\t\t\t\r\n\t\t} else {\r\n\t\t\t\r\n\t\t\tdata.node.state = ndm.CONSTANTS.States.Ready;\r\n\t\t\t\r\n\t\t\t// Emit event NodeAdded\r\n\t\t\tndm.eventEmitter.emit( ndm.CONSTANTS.Events.NodeAdded, data );\r\n\t\t}\r\n\t\t\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * Event NodeDisconnected\r\n\t */\r\n\t_event_NodeDisconnected(data, stNode) {\r\n\t\t\r\n\t\tlet ndm = this;\r\n\t\t\r\n\t\tlet nodeSearh = ndm.getNodeBySocket(data.node.socket);\r\n\t\t\r\n\t\tlet nodeID = stNode.config.nodeID.toString();\r\n\t\t\r\n\t\tif (nodeSearh.stNode !== null) {\r\n\t\t\tndm.nodeList.splice(nodeSearh.position, 1);\r\n\t\t\t\r\n\t\t\t// Emit event NodeRemoved\r\n\t\t\tndm.eventEmitter.emit( ndm.CONSTANTS.Events.NodeRemoved, {\"nodeID\" : nodeID} );\r\n\t\t}\r\n\t\t\r\n\t}\r\n\r\n}\r\n\r\n\r\nmodule.exports = NodesManager;"],"sourceRoot":"C:\\Users\\Felipe\\Documents\\Work\\SomeThings\\dev\\NLVL_STServer\\es6"}